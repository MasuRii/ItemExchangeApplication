{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <title>{{ profile_user.get_full_name|default:profile_user.username }} - SwapSpot</title>
  <link href="{% static 'css/user_profile.css' %}" rel="stylesheet">
  <script defer>
    // Function to toggle the dropdown visibility
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    // Functions to handle Add Item modal
    function openAddItemModal() {
      document.getElementById('addItemModal').style.display = 'block';
    }

    function closeAddItemModal() {
      document.getElementById('addItemModal').style.display = 'none';
    }

    // Close the modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('addItemModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="brand-logo">
        <a href="{% url 'exchange:homepage' %}">
          <img alt="SwapSpot Logo" src="{% static 'svg/swapspot-logo-dark.svg' %}" class="logo-icon">
        </a>
      </div>
      <div class="nav-links">
        <ul>
          <li><a href="{% url 'exchange:user_profile' username=request.user.username %}" {% if request.user == profile_user %}class="active"{% endif %}>Profile</a></li>
          <li><a href="#">List</a></li>
          <li><a href="{% url 'exchange:user_profile_settings' %}">Settings</a></li>
          <li><a href="#">Help & Support</a></li>
        </ul>
      </div>
      <div class="user-profile" onclick="toggleDropdown(event)">
        {% if request.user.profile_picture %}
          <img alt="Profile Picture" src="{{ request.user.profile_picture.url }}">
        {% else %}
          <img alt="Profile Picture" src="{% static 'images/defaultpfp.png' %}">
        {% endif %}
        <div class="dropdown-menu" id="dropdownMenu">
          <ul>
            <li><a href="{% url 'exchange:logout' %}">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="profile-layout">
    <div class="left-section">
      <div class="profile-picture-container">
        {% if profile_user.profile_picture %}
          <img alt="Profile Picture" src="{{ profile_user.profile_picture.url }}" class="profile-picture">
        {% else %}
          <img alt="Profile Picture" src="{% static 'images/defaultpfp.png' %}" class="profile-picture">
        {% endif %}
      </div>
      <h1 class="username">{{ profile_user.get_full_name|default:profile_user.username }}</h1>
      <p class="bio">
        {% if profile_user.bio %}
          {{ profile_user.bio }}
        {% else %}
          This user hasn't written a bio yet.
        {% endif %}
      </p>
      <hr class="section-divider">
      <div class="details">
        <p><strong>Joined:</strong> {{ profile_user.date_joined|date:"F d, Y" }}</p>
        <p><strong>Current rating:</strong> <span class="stars">⭐⭐⭐⭐☆</span> <span class="rating-count">(321)</span></p>
        <p><strong>Location:</strong>
          {% if profile_user.country %}{{ profile_user.country }}{% else %}Country{% endif %},
          {% if profile_user.city %}{{ profile_user.city }}{% else %}City{% endif %}
        </p>
        {% if is_own_profile %}
          <p><strong>Contact:</strong> {{ profile_user.contact|default:"N/A" }}</p>
          <p><strong>Email:</strong> {{ profile_user.email }}</p>
        {% endif %}
      </div>

      {% if is_own_profile %}
        <div class="add-listing-container">
          <button class="add-product-btn" onclick="openAddItemModal()">Add Item</button>
        </div>
      {% endif %}
    </div>

    <div class="grid-container">
      {% for item in items %}
        <div class="product-card">
          <a href="{% url 'exchange:item_detail' item_id=item.item_id %}" class="product-link">
            {% if item.picture %}
              <img alt="{{ item.title }}" src="{{ item.picture.url }}" class="product-img-frame">
            {% else %}
              <img alt="Default Product" src="{% static 'images/default-product.jpg' %}" class="product-img-frame">
            {% endif %}
            <div class="card-content">
              <p class="title">{{ item.title }}</p>
              <p class="price">PHP {{ item.price }}</p>
              <p class="location">
                {% if item.user.city and item.user.country %}
                  {{ item.user.city }}, {{ item.user.country }}
                {% elif item.user.city %}
                  {{ item.user.city }}
                {% elif item.user.country %}
                  {{ item.user.country }}
                {% else %}
                  Location not specified
                {% endif %}
              </p>
            </div>
          </a>
          <div class="card-actions">
            <button class="view-listing-btn">View Listing</button>
          </div>
        </div>
      {% empty %}
        <p>No items to display.</p>
      {% endfor %}
    </div>
  </div>

  {% if is_own_profile %}
    <div class="modal" id="addItemModal">
      <div class="modal-content">
        <span class="close" onclick="closeAddItemModal()">×</span>
        <h2>Add New Item</h2>
        <form action="{% url 'exchange:add_item' %}" enctype="multipart/form-data" id="addItemForm" method="POST">
          {% csrf_token %}
          {% if form.errors %}
            <div class="form-errors">
              <ul>
                {% for field in form %}
                  {% for error in field.errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {{ form.as_p }}
          <button class="submit-btn" type="submit">Add Item</button>
        </form>
      </div>
    </div>
  {% endif %}

  <footer class="footer">
    <p class="terms">SwapSpot's Terms and Conditions</p>
    <p class="security">Safety and Security</p>
    <p class="how">How bartering works</p>
    <p class="pledge">SwapSpot's Pledge</p>
    <p class="contact">Contact Us</p>
    <p class="copyright">© The SwapSpot Team 2024</p>
  </footer>
</body>
</html>